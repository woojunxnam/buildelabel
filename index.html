<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ePI FHIR XML Generator (MFDS Compatible - v2.2)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #34495e; font-size: 1.2em; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9em; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        input[type="file"] { border: 1px solid #ccc; padding: 10px; width: 100%; background: #fafafa; border-radius: 4px; }
        .file-preview { border: 1px dashed #ccc; padding: 10px; background: #f9f9f9; max-height: 200px; overflow-y: auto; font-size: 0.8em; color: #333; margin-top: 5px; display: none; }
        .file-preview table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .file-preview th, .file-preview td { border: 1px solid #ccc; padding: 5px; }
        .row-container { margin-bottom: 10px; display: flex; gap: 10px; }
        .ingredient-wrapper { background: #fafafa; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        .base-amount-line { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 1.1em; font-weight: bold; }
        .ing-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .ing-table th { background: #eceff1; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; font-size: 0.9em; }
        .ing-table td { padding: 5px; border-bottom: 1px solid #eee; }
        .ing-table input { width: 100%; border: 1px solid #ddd; padding: 8px; }
        .btn-add { background-color: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .btn-remove { background-color: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .action-area { margin-top: 40px; text-align: center; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-generate { background-color: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 1.1em; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .btn-generate:hover { background-color: #219150; }
    </style>
</head>
<body>

<div class="container">
    <h1>ePI XML Builder (v2.2)</h1>

    <!-- 1. Basic Info -->
    <h2>기본 정보 (Author/Organization)</h2>
    <div class="form-group">
        <label for="orgName">업체명 (작성자/소유자)</label>
        <input type="text" id="orgName" placeholder="예: 한국제약 주식회사">
    </div>
    <div class="form-group">
        <label for="externalId">외부 식별자 (External ID)</label>
        <input type="text" id="externalId" placeholder="예: KR-12345678">
    </div>

    <!-- 2. Product Names -->
    <h2>제품명</h2>
    <div id="productNameContainer">
        <div class="row-container">
            <input type="text" class="product-name-input" placeholder="제품명 입력">
        </div>
    </div>
    <button type="button" class="btn-add" onclick="addProductRow()">+ 제품명 추가</button>

    <!-- 3. Detail Inputs -->
    <h2>상세 정보</h2>
    
    <div class="form-group">
        <label>성상</label>
        <textarea id="appearance" style="height:80px;" placeholder="성상을 입력하세요"></textarea>
    </div>

    <!-- Ingredient Table -->
    <div class="form-group">
        <label>원료약품 및 분량 **</label>
        <div class="ingredient-wrapper">
            <div class="base-amount-line">
                <span>이 약 </span>
                <input type="text" id="ingBaseAmount" placeholder="예: 1mL" style="width: 150px;">
                <span> 중</span>
            </div>
            <table class="ing-table" id="ingTable">
                <thead>
                    <tr>
                        <th width="20%">배합목적</th>
                        <th width="35%">원료명</th>
                        <th width="20%">분량</th>
                        <th width="20%">규격</th>
                        <th width="5%"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" class="ing-purpose" placeholder="예: 주성분"></td>
                        <td><input type="text" class="ing-name" placeholder="예: 이오헥솔"></td>
                        <td><input type="text" class="ing-qty" placeholder="예: 647mg"></td>
                        <td><input type="text" class="ing-std" placeholder="예: USP"></td>
                        <td><button type="button" class="btn-remove" onclick="removeRow(this)">X</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn-add" onclick="addIngredientRow()">+ 원료 추가</button>
        </div>
    </div>

    <!-- XML File Uploads -->
    <div class="form-group">
        <label>효능효과 (XML 파일 업로드) **</label>
        <input type="file" id="fileIndications" accept=".xml" onchange="handleFileUpload(this, 'previewIndications')">
        <div id="previewIndications" class="file-preview"></div>
        <input type="hidden" id="dataIndications">
    </div>

    <div class="form-group">
        <label>용법용량 (XML 파일 업로드) **</label>
        <input type="file" id="fileDosage" accept=".xml" onchange="handleFileUpload(this, 'previewDosage')">
        <div id="previewDosage" class="file-preview"></div>
        <input type="hidden" id="dataDosage">
    </div>

    <div class="form-group">
        <label>사용상의 주의사항 (XML 파일 업로드) **</label>
        <input type="file" id="filePrecautions" accept=".xml" onchange="handleFileUpload(this, 'previewPrecautions')">
        <div id="previewPrecautions" class="file-preview"></div>
        <input type="hidden" id="dataPrecautions">
    </div>

    <!-- Remaining Info -->
    <div class="form-group">
        <label>포장단위</label>
        <input type="text" id="packaging" placeholder="예: 30정/병">
    </div>

    <div class="form-group">
        <label>저장방법</label>
        <input type="text" id="storage" placeholder="예: 기밀용기, 실온보관">
    </div>

    <div class="form-group">
        <label>사용기간</label>
        <input type="text" id="shelfLife" placeholder="예: 제조일로부터 36개월">
    </div>

    <div class="form-group">
        <label>기타 안내사항</label>
        <textarea id="otherInfo" style="height:80px;" placeholder="기타 정보를 입력하세요"></textarea>
    </div>

    <!-- 4. Manufacturing Info -->
    <h2>제조/수입 정보</h2>
    <div class="form-group">
        <label>제조원 (업체명)</label>
        <input type="text" id="manufacturer" placeholder="제조원 업체명 (작성자와 동일시 자동 처리)">
    </div>
    <div class="form-group">
        <label>수입자 (업체명)</label>
        <input type="text" id="importer" placeholder="수입자 업체명 (해당 없을 시 공란)">
    </div>

    <!-- Action -->
    <div class="action-area">
        <button type="button" class="btn-generate" onclick="generateXML()">FHIR XML 생성 및 다운로드</button>
    </div>
</div>

<script>
    // ------------------------------------------------------------------
    // 1. Parsing Logic (Updated to preserve <sup>, <sub>, <b>)
    // ------------------------------------------------------------------
    function handleFileUpload(inputElement, previewId) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const xmlContent = e.target.result;
            // Parse XML and extract HTML
            const rawHtml = parseMfdsXmlToHtml(xmlContent);
            // No extra ensureXHTML call needed here as it's done per paragraph in parsing
            // But we do it one last time to be safe for the preview
            const previewDiv = document.getElementById(previewId);
            previewDiv.style.display = 'block';
            previewDiv.innerHTML = rawHtml; 
            
            // Store hidden data
            const hiddenInputId = inputElement.id.replace('file', 'data'); 
            document.getElementById(hiddenInputId).value = rawHtml;
        };
        reader.readAsText(file);
    }

    function parseMfdsXmlToHtml(xmlString) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");
        
        let htmlOutput = "";
        const articles = xmlDoc.getElementsByTagName("ARTICLE");
        
        const processParagraphs = (paragraphs) => {
            let chunkHtml = "";
            for (let j = 0; j < paragraphs.length; j++) {
                let text = paragraphs[j].textContent.trim();
                if (!text) continue;

                // Detect Table
                const isTable = text.includes('<tbody') || text.includes('<tr') || text.includes('<table');
                
                if (isTable) {
                    if (!text.includes('<table')) {
                        text = `<table border="1" cellspacing="0" cellpadding="5" style="border-collapse: collapse; width: 100%; margin-top: 10px;">${text}</table>`;
                    }
                    chunkHtml += `<div>${ensureXHTML(text)}</div>`;
                } else {
                    // Check for block level tags or just text with inline tags
                    const lower = text.toLowerCase();
                    // If it starts with a block tag, don't wrap in <p>
                    if (lower.startsWith('<p') || lower.startsWith('<div')) {
                        chunkHtml += ensureXHTML(text);
                    } else {
                        // Plain text or text with inline tags (<sup>, <b>, etc.)
                        // Wrap in <p> but DO NOT escape HTML tags inside.
                        chunkHtml += `<p>${ensureXHTML(text)}</p>`;
                    }
                }
            }
            return chunkHtml;
        };

        if (articles.length > 0) {
            for (let i = 0; i < articles.length; i++) {
                const article = articles[i];
                const title = article.getAttribute("title");
                if (title) htmlOutput += `<h4>${escapeHtml(title)}</h4>`; // Sub-headers within XML
                
                const paragraphs = article.getElementsByTagName("PARAGRAPH");
                htmlOutput += processParagraphs(paragraphs);
            }
        } else {
            const paragraphs = xmlDoc.getElementsByTagName("PARAGRAPH");
            htmlOutput += processParagraphs(paragraphs);
        }
        return htmlOutput;
    }

    // Helper: Validates HTML string and returns XHTML safe string
    // Preserves tags like <sup>, <sub>, <b>, etc.
    // Handles &nbsp; -> &#160;
    function ensureXHTML(htmlString) {
        // Parse as HTML (this allows browser to handle <sup> tags correctly)
        const doc = new DOMParser().parseFromString(`<div>${htmlString}</div>`, 'text/html');
        
        const serializer = new XMLSerializer();
        let result = "";
        
        // Serialize children back to XML string
        if(doc.body.firstChild) {
            for(let child of doc.body.firstChild.childNodes) {
                result += serializer.serializeToString(child);
            }
        }

        // Replacements for strict XML validity
        return result
            .replace(/&nbsp;/g, "&#160;")
            .replace(/\u00A0/g, "&#160;");
    }

    // ------------------------------------------------------------------
    // 2. Utils
    // ------------------------------------------------------------------
    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function getIsoTimestamp() { return new Date().toISOString(); }
    function getCurrentDate() { return new Date().toISOString().split('T')[0]; }

    // Standard escape for manual text inputs where no HTML is expected
    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ------------------------------------------------------------------
    // 3. UI Logic
    // ------------------------------------------------------------------
    function addProductRow() {
        const container = document.getElementById('productNameContainer');
        const div = document.createElement('div');
        div.className = 'row-container';
        div.innerHTML = `
            <input type="text" class="product-name-input" placeholder="추가 제품명 입력">
            <button type="button" class="btn-remove" onclick="this.parentElement.remove()">삭제</button>
        `;
        container.appendChild(div);
    }

    function addIngredientRow() {
        const tbody = document.querySelector('#ingTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="ing-purpose"></td>
            <td><input type="text" class="ing-name"></td>
            <td><input type="text" class="ing-qty"></td>
            <td><input type="text" class="ing-std"></td>
            <td><button type="button" class="btn-remove" onclick="removeRow(this)">X</button></td>
        `;
        tbody.appendChild(tr);
    }

    function removeRow(btn) { btn.closest('tr').remove(); }

    // ------------------------------------------------------------------
    // 4. Enhanced FHIR Generation Logic (With Titles)
    // ------------------------------------------------------------------
    function generateXML() {
        // --- Data Gathering ---
        const orgName = document.getElementById('orgName').value.trim() || 'Unknown Organization';
        const externalId = document.getElementById('externalId').value.trim() || 'UNKNOWN-ID';
        
        // Product Names
        const productInputs = document.querySelectorAll('.product-name-input');
        let productNamesList = [];
        productInputs.forEach(input => { if(input.value.trim()) productNamesList.push(input.value.trim()); });
        const mainTitle = productNamesList.length > 0 ? productNamesList[0] : 'Product Name';
        // Note: We don't usually add a header inside the Product Name section itself as the section title says "Product Name"
        const productNameHtml = productNamesList.map(name => `<p>${escapeHtml(name)}</p>`).join('');

        // Ingredients
        const ingBaseAmount = document.getElementById('ingBaseAmount').value;
        const ingRows = document.querySelectorAll('#ingTable tbody tr');
        let ingredientHtml = `<h3>원료약품 및 분량</h3>`; // Added Title
        
        if(ingBaseAmount) ingredientHtml += `<p>이 약 ${escapeHtml(ingBaseAmount)} 중</p>`;
        
        ingredientHtml += `<table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse: collapse;"><thead><tr style="background-color:#f0f0f0;"><th>배합목적</th><th>원료명</th><th>분량</th><th>규격</th></tr></thead><tbody>`;
        let hasIngredients = false;
        ingRows.forEach(row => {
            const purpose = row.querySelector('.ing-purpose').value;
            const name = row.querySelector('.ing-name').value;
            const qty = row.querySelector('.ing-qty').value;
            const std = row.querySelector('.ing-std').value;
            if(purpose || name || qty || std) {
                ingredientHtml += `<tr><td>${escapeHtml(purpose)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(qty)}</td><td>${escapeHtml(std)}</td></tr>`;
                hasIngredients = true;
            }
        });
        ingredientHtml += `</tbody></table>`;
        if(!hasIngredients) ingredientHtml = `<h3>원료약품 및 분량</h3><p>정보 없음</p>`;

        // Texts - Added Titles
        const indicationsRaw = document.getElementById('dataIndications').value;
        const indicationsHtml = `<h3>효능효과</h3>` + (indicationsRaw || '<p>정보 없음</p>');

        const dosageRaw = document.getElementById('dataDosage').value;
        const dosageHtml = `<h3>용법용량</h3>` + (dosageRaw || '<p>정보 없음</p>');

        const precautionsRaw = document.getElementById('dataPrecautions').value;
        const precautionsHtml = `<h3>사용상의 주의사항</h3>` + (precautionsRaw || '<p>정보 없음</p>');
        
        // Manual Texts - Added Titles
        const appearanceRaw = escapeHtml(document.getElementById('appearance').value);
        const appearanceHtml = `<h3>성상</h3><p>${appearanceRaw}</p>`;

        const packagingRaw = escapeHtml(document.getElementById('packaging').value);
        const packagingHtml = `<h3>포장단위</h3><p>${packagingRaw}</p>`;

        const storageRaw = escapeHtml(document.getElementById('storage').value);
        const shelfLifeRaw = escapeHtml(document.getElementById('shelfLife').value);
        const storageAndShelfLifeHtml = `<h3>저장방법 및 사용기간</h3><p><strong>저장방법:</strong> ${storageRaw}</p><p><strong>사용기간:</strong> ${shelfLifeRaw}</p>`;

        const otherInfoRaw = document.getElementById('otherInfo').value;
        const otherInfoHtml = `<h3>기타 안내사항</h3>` + (otherInfoRaw ? `<p>${escapeHtml(otherInfoRaw)}</p>` : "<p>정보 없음</p>");

        const manufName = document.getElementById('manufacturer').value.trim() || orgName;
        const importerName = document.getElementById('importer').value.trim();

        // --- ID Management ---
        const bundleId = uuidv4();
        const compositionId = uuidv4();
        const timestamp = getIsoTimestamp();
        const dateOnly = getCurrentDate();

        let orgRegistry = {};

        function getOrgId(name) {
            if(!name) return null;
            if(!orgRegistry[name]) {
                orgRegistry[name] = uuidv4();
            }
            return orgRegistry[name];
        }

        const authorOrgId = getOrgId(orgName);
        const manufOrgId = getOrgId(manufName);
        const importerOrgId = getOrgId(importerName);

        // --- Build XML ---
        let bundleEntries = [];

        // 1. COMPOSITION Entry
        let sections = [];
        
        const addSection = (title, code, textContent, entryRefId = null) => {
            let sectionXml = `<section><title value="${title}"/><code><coding><system value="2.16.840.1.113883.6.1"/><code value="${code}"/><display value="Section"/></coding></code>`;
            if (textContent) {
                // IMPORTANT: The text content already has <h3> headers embedded above
                sectionXml += `<text><div xmlns="http://www.w3.org/1999/xhtml">${textContent}</div></text>`;
            }
            if (entryRefId) {
                sectionXml += `<entry><reference value="urn:uuid:${entryRefId}"/></entry>`;
            }
            sectionXml += `</section>`;
            sections.push(sectionXml);
        };

        addSection("제품명", "69718-5", productNameHtml);
        addSection("성상", "34089-3", appearanceHtml);
        addSection("원료약품 및 그 분량", "34089-3", ingredientHtml);
        addSection("효능효과", "34067-9", indicationsHtml);
        addSection("용법·용량", "34068-7", dosageHtml);
        addSection("사용상의 주의사항", "43685-7", precautionsHtml);
        addSection("포장단위", "34069-5", packagingHtml);
        addSection("저장방법, 사용기간", "44425-7", storageAndShelfLifeHtml);
        addSection("제조원", "42229-5", null, manufOrgId); // No text, only ref
        
        if (importerOrgId) {
            addSection("수입자", "42229-5", null, importerOrgId);
        }

        addSection("기타 안내사항", "42229-5", otherInfoHtml);

        const compositionXml = `
    <entry>
        <fullUrl value="urn:uuid:${compositionId}"/>
        <resource>
            <Composition>
                <id value="${compositionId}"/>
                <meta><profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Composition-uv-epi"/></meta>
                <status value="final"/>
                <type><coding><system value="2.16.840.1.113883.6.1"/><code value="60591-5"/><display value="Summary of Product Characteristics"/></coding></type>
                <title value="${escapeHtml(mainTitle)}"/>
                <date value="${dateOnly}"/>
                <author><reference value="urn:uuid:${authorOrgId}"/></author>
                <language value="ko"/>
                ${sections.join('')}
            </Composition>
        </resource>
    </entry>`;
        bundleEntries.push(compositionXml);

        // 2. ORGANIZATION Entries
        for (const [name, id] of Object.entries(orgRegistry)) {
            const orgXml = `
    <entry>
        <fullUrl value="urn:uuid:${id}"/>
        <resource>
            <Organization>
                <id value="${id}"/>
                <meta><profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Organization-uv-epi"/></meta>
                <name value="${escapeHtml(name)}"/>
            </Organization>
        </resource>
    </entry>`;
            bundleEntries.push(orgXml);
        }

        // --- Final Assembly ---
        let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<Bundle xmlns="http://hl7.org/fhir">
  <id value="${bundleId}"/>
  <meta>
    <versionId value="1"/>
    <lastUpdated value="${timestamp}"/>
    <profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Bundle-uv-epi"/>
  </meta>
  <language value="ko"/>
  <identifier>
    <system value="https://mfds.go.kr/fhir/epiGuid"/>
    <value value="${escapeHtml(externalId)}"/>
  </identifier>
  <type value="document"/>
  <timestamp value="${timestamp}"/>
  ${bundleEntries.join('')}
</Bundle>`;

        downloadFile("epi-document.xml", xmlContent);
    }

    function downloadFile(filename, content) {
        const element = document.createElement('a');
        const blob = new Blob([content], {type: 'text/xml'});
        element.href = URL.createObjectURL(blob);
        element.download = filename;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
</script>

</body>
</html>
