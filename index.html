<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ePI FHIR XML Generator (MFDS Compatible)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #34495e; font-size: 1.2em; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9em; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        
        /* File Input Styling */
        input[type="file"] { border: 1px solid #ccc; padding: 10px; width: 100%; background: #fafafa; border-radius: 4px; }
        .file-status { font-size: 0.85em; color: #27ae60; margin-top: 5px; display: none; font-weight: bold; }
        .file-preview { border: 1px dashed #ccc; padding: 10px; background: #f9f9f9; max-height: 150px; overflow-y: auto; font-size: 0.8em; color: #555; margin-top: 5px; display: none; }

        /* Product Name Rows */
        .row-container { margin-bottom: 10px; display: flex; gap: 10px; }

        /* Ingredient Table Styling */
        .ingredient-wrapper { background: #fafafa; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        .base-amount-line { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 1.1em; font-weight: bold; }
        .ing-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .ing-table th { background: #eceff1; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; font-size: 0.9em; }
        .ing-table td { padding: 5px; border-bottom: 1px solid #eee; }
        .ing-table input { width: 100%; border: 1px solid #ddd; padding: 8px; }
        
        /* Buttons */
        .btn-add { background-color: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .btn-remove { background-color: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        
        .action-area { margin-top: 40px; text-align: center; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-generate { background-color: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 1.1em; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .btn-generate:hover { background-color: #219150; }
    </style>
</head>
<body>

<div class="container">
    <h1>ePI XML Builder</h1>

    <!-- 1. Basic Info -->
    <h2>기본 정보 (Author/Organization)</h2>
    <div class="form-group">
        <label for="orgName">업체명 (작성자/소유자)</label>
        <input type="text" id="orgName" placeholder="예: 한국제약 주식회사">
    </div>
    <div class="form-group">
        <label for="externalId">외부 식별자 (External ID)</label>
        <input type="text" id="externalId" placeholder="예: KR-12345678">
    </div>

    <!-- 2. Product Names -->
    <h2>제품명</h2>
    <div id="productNameContainer">
        <div class="row-container">
            <input type="text" class="product-name-input" placeholder="제품명 입력">
        </div>
    </div>
    <button type="button" class="btn-add" onclick="addProductRow()">+ 제품명 추가</button>

    <!-- 3. Detail Inputs -->
    <h2>상세 정보</h2>
    
    <div class="form-group">
        <label>성상</label>
        <textarea id="appearance" style="height:80px;" placeholder="성상을 입력하세요"></textarea>
    </div>

    <!-- Ingredient Table -->
    <div class="form-group">
        <label>원료약품 및 분량 **</label>
        <div class="ingredient-wrapper">
            <div class="base-amount-line">
                <span>이 약 </span>
                <input type="text" id="ingBaseAmount" placeholder="예: 1mL" style="width: 150px;">
                <span> 중</span>
            </div>
            <table class="ing-table" id="ingTable">
                <thead>
                    <tr>
                        <th width="20%">배합목적</th>
                        <th width="35%">원료명</th>
                        <th width="20%">분량</th>
                        <th width="20%">규격</th>
                        <th width="5%"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" class="ing-purpose" placeholder="예: 주성분"></td>
                        <td><input type="text" class="ing-name" placeholder="예: 이오헥솔"></td>
                        <td><input type="text" class="ing-qty" placeholder="예: 647mg"></td>
                        <td><input type="text" class="ing-std" placeholder="예: USP"></td>
                        <td><button type="button" class="btn-remove" onclick="removeRow(this)">X</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn-add" onclick="addIngredientRow()">+ 원료 추가</button>
        </div>
    </div>

    <!-- XML File Uploads for Main Sections -->
    <div class="form-group">
        <label>효능효과 (XML 파일 업로드) **</label>
        <input type="file" id="fileIndications" accept=".xml" onchange="handleFileUpload(this, 'previewIndications')">
        <div id="previewIndications" class="file-preview"></div>
        <input type="hidden" id="dataIndications">
    </div>

    <div class="form-group">
        <label>용법용량 (XML 파일 업로드) **</label>
        <input type="file" id="fileDosage" accept=".xml" onchange="handleFileUpload(this, 'previewDosage')">
        <div id="previewDosage" class="file-preview"></div>
        <input type="hidden" id="dataDosage">
    </div>

    <div class="form-group">
        <label>사용상의 주의사항 (XML 파일 업로드) **</label>
        <input type="file" id="filePrecautions" accept=".xml" onchange="handleFileUpload(this, 'previewPrecautions')">
        <div id="previewPrecautions" class="file-preview"></div>
        <input type="hidden" id="dataPrecautions">
    </div>

    <!-- Remaining Info -->
    <div class="form-group">
        <label>포장단위</label>
        <input type="text" id="packaging" placeholder="예: 30정/병">
    </div>

    <div class="form-group">
        <label>저장방법</label>
        <input type="text" id="storage" placeholder="예: 기밀용기, 실온보관">
    </div>

    <div class="form-group">
        <label>사용기간</label>
        <input type="text" id="shelfLife" placeholder="예: 제조일로부터 36개월">
    </div>

    <div class="form-group">
        <label>기타 안내사항</label>
        <textarea id="otherInfo" style="height:80px;" placeholder="기타 정보를 입력하세요"></textarea>
    </div>

    <!-- 4. Manufacturing Info -->
    <h2>제조/수입 정보</h2>
    <div class="form-group">
        <label>제조원 (업체명)</label>
        <input type="text" id="manufacturer" placeholder="제조원 업체명">
    </div>
    <div class="form-group">
        <label>수입자 (업체명)</label>
        <input type="text" id="importer" placeholder="수입자 업체명 (해당 없을 시 공란)">
    </div>

    <!-- Action -->
    <div class="action-area">
        <button type="button" class="btn-generate" onclick="generateXML()">FHIR XML 생성 및 다운로드</button>
    </div>
</div>

<script>
    // ------------------------------------------------------------------
    // 1. MFDS XML Parsing Logic
    // ------------------------------------------------------------------
    function handleFileUpload(inputElement, previewId) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const xmlContent = e.target.result;
            const parsedHTML = parseMfdsXmlToHtml(xmlContent);
            
            // Show preview
            const previewDiv = document.getElementById(previewId);
            previewDiv.style.display = 'block';
            previewDiv.textContent = "Parsed Content Preview: " + parsedHTML.replace(/<[^>]*>?/gm, '').substring(0, 100) + "...";
            
            // Store hidden data
            // We store the 'clean' HTML to be injected into the FHIR bundle
            const hiddenInputId = inputElement.id.replace('file', 'data'); 
            document.getElementById(hiddenInputId).value = parsedHTML;
        };
        reader.readAsText(file);
    }

    function parseMfdsXmlToHtml(xmlString) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");
        
        let htmlOutput = "";
        
        // Find all ARTICLES. Structure: DOC -> SECTION -> ARTICLE -> PARAGRAPH
        const articles = xmlDoc.getElementsByTagName("ARTICLE");
        
        if (articles.length > 0) {
            for (let i = 0; i < articles.length; i++) {
                const article = articles[i];
                const title = article.getAttribute("title");
                
                if (title) {
                    htmlOutput += `<h3>${escapeHtml(title)}</h3>`;
                }
                
                const paragraphs = article.getElementsByTagName("PARAGRAPH");
                for (let j = 0; j < paragraphs.length; j++) {
                    // textContent retrieves text inside CDATA as well
                    const text = paragraphs[j].textContent; 
                    // We wrap it in <p>. Note: if CDATA contained HTML tags (like <sup>), 
                    // they are now part of the string. We trust the input or escape it.
                    // For FHIR readable text, we generally want to allow basic formatting if present,
                    // but to be safe against XML errors, we can escape the text content.
                    htmlOutput += `<p>${escapeHtml(text)}</p>`;
                }
            }
        } else {
            // Fallback if no ARTICLE tags found (just dump all paragraphs)
            const paragraphs = xmlDoc.getElementsByTagName("PARAGRAPH");
            for (let j = 0; j < paragraphs.length; j++) {
                htmlOutput += `<p>${escapeHtml(paragraphs[j].textContent)}</p>`;
            }
        }

        return htmlOutput;
    }

    // ------------------------------------------------------------------
    // 2. Standard Utilities
    // ------------------------------------------------------------------
    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function getIsoTimestamp() { return new Date().toISOString(); }
    function getCurrentDate() { return new Date().toISOString().split('T')[0]; }

    function escapeHtml(text) {
        if (!text) return '';
        // Note: For the XML Parser above, we might be double escaping if we are not careful.
        // But for standard text inputs, this is required.
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ------------------------------------------------------------------
    // 3. Dynamic Rows Logic
    // ------------------------------------------------------------------
    function addProductRow() {
        const container = document.getElementById('productNameContainer');
        const div = document.createElement('div');
        div.className = 'row-container';
        div.innerHTML = `
            <input type="text" class="product-name-input" placeholder="추가 제품명 입력">
            <button type="button" class="btn-remove" onclick="this.parentElement.remove()">삭제</button>
        `;
        container.appendChild(div);
    }

    function addIngredientRow() {
        const tbody = document.querySelector('#ingTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="ing-purpose"></td>
            <td><input type="text" class="ing-name"></td>
            <td><input type="text" class="ing-qty"></td>
            <td><input type="text" class="ing-std"></td>
            <td><button type="button" class="btn-remove" onclick="removeRow(this)">X</button></td>
        `;
        tbody.appendChild(tr);
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
    }

    // ------------------------------------------------------------------
    // 4. Main Generation Logic
    // ------------------------------------------------------------------
    function generateXML() {
        // Basic Info
        const orgName = document.getElementById('orgName').value || 'Unknown Organization';
        const externalId = document.getElementById('externalId').value || 'UNKNOWN-ID';
        
        // Product Name
        const productInputs = document.querySelectorAll('.product-name-input');
        let productNamesList = [];
        productInputs.forEach(input => { if(input.value.trim()) productNamesList.push(input.value.trim()); });
        const mainTitle = productNamesList.length > 0 ? productNamesList[0] : 'Product Name';
        const productNameHtml = productNamesList.map(name => `<p>${escapeHtml(name)}</p>`).join('');

        // Ingredients (Table Construction)
        const ingBaseAmount = document.getElementById('ingBaseAmount').value;
        const ingRows = document.querySelectorAll('#ingTable tbody tr');
        let ingredientHtml = "";
        if(ingBaseAmount) ingredientHtml += `<p>이 약 ${escapeHtml(ingBaseAmount)} 중</p>`;
        else ingredientHtml += `<p>원료약품 및 분량</p>`;
        
        ingredientHtml += `<table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse: collapse;"><thead><tr style="background-color:#f0f0f0;"><th>배합목적</th><th>원료명</th><th>분량</th><th>규격</th></tr></thead><tbody>`;
        ingRows.forEach(row => {
            const purpose = row.querySelector('.ing-purpose').value;
            const name = row.querySelector('.ing-name').value;
            const qty = row.querySelector('.ing-qty').value;
            const std = row.querySelector('.ing-std').value;
            if(purpose || name || qty || std) {
                ingredientHtml += `<tr><td>${escapeHtml(purpose)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(qty)}</td><td>${escapeHtml(std)}</td></tr>`;
            }
        });
        ingredientHtml += `</tbody></table>`;

        // Retrieve Parsed XML Data (or empty if not uploaded)
        // Note: These strings are already formatted as HTML tags (<h3>, <p>) by the parser.
        // We do NOT escape them again here, otherwise tags will show as text.
        const indicationsHtml = document.getElementById('dataIndications').value || '<p>정보 없음</p>';
        const dosageHtml = document.getElementById('dataDosage').value || '<p>정보 없음</p>';
        const precautionsHtml = document.getElementById('dataPrecautions').value || '<p>정보 없음</p>';

        // Other Inputs
        const appearance = escapeHtml(document.getElementById('appearance').value);
        const packaging = escapeHtml(document.getElementById('packaging').value);
        const storage = escapeHtml(document.getElementById('storage').value);
        const shelfLife = escapeHtml(document.getElementById('shelfLife').value);
        const otherInfo = escapeHtml(document.getElementById('otherInfo').value);
        const manufName = document.getElementById('manufacturer').value || orgName;
        const importerName = document.getElementById('importer').value || '';

        // UUIDs
        const bundleId = uuidv4();
        const compositionId = uuidv4();
        const authorOrgId = uuidv4();
        const manufOrgId = uuidv4();
        const importerOrgId = uuidv4();
        const timestamp = getIsoTimestamp();
        const dateOnly = getCurrentDate();

        // -------------------------------------------------------
        // Construct Final FHIR XML
        // -------------------------------------------------------
        let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<Bundle xmlns="http://hl7.org/fhir">
  <id value="${bundleId}"/>
  <meta>
    <versionId value="1"/>
    <lastUpdated value="${timestamp}"/>
    <profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Bundle-uv-epi"/>
  </meta>
  <language value="ko"/>
  <identifier>
    <system value="https://mfds.go.kr/fhir/epiGuid"/>
    <value value="${escapeHtml(externalId)}"/>
  </identifier>
  <type value="document"/>
  <timestamp value="${timestamp}"/>

  <entry>
    <fullUrl value="urn:uuid:${compositionId}"/>
    <resource>
      <Composition>
        <id value="${compositionId}"/>
        <meta>
          <profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Composition-uv-epi"/>
        </meta>
        <status value="final"/>
        <type>
          <coding>
            <system value="2.16.840.1.113883.6.1"/>
            <code value="60591-5"/>
            <display value="Summary of Product Characteristics"/>
          </coding>
        </type>
        <title value="${escapeHtml(mainTitle)}"/>
        <date value="${dateOnly}"/>
        <author>
          <reference value="urn:uuid:${authorOrgId}"/>
        </author>
        <language value="ko"/>

        <!-- 1. 제품명 -->
        <section>
          <title value="제품명"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="69718-5"/><display value="Statement of identity section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml">${productNameHtml}</div></text>
        </section>

        <!-- 2. 성상 -->
        <section>
          <title value="성상"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="34089-3"/><display value="Description section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml"><p>${appearance}</p></div></text>
        </section>

        <!-- 3. 원료약품 및 분량 -->
        <section>
          <title value="원료약품 및 그 분량"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="34089-3"/><display value="Description section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml">${ingredientHtml}</div></text>
        </section>

        <!-- 4. 효능효과 (From XML) -->
        <section>
          <title value="효능효과"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="34067-9"/><display value="Indications and usage section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml">${indicationsHtml}</div></text>
        </section>

        <!-- 5. 용법용량 (From XML) -->
        <section>
          <title value="용법·용량"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="34068-7"/><display value="Dosage and administration section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml">${dosageHtml}</div></text>
        </section>

        <!-- 6. 사용상의 주의사항 (From XML) -->
        <section>
          <title value="사용상의 주의사항"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="43685-7"/><display value="Warnings and precautions section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml">${precautionsHtml}</div></text>
        </section>

        <!-- 7. 포장단위 -->
        <section>
          <title value="포장단위"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="34069-5"/><display value="How supplied section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml"><p>${packaging}</p></div></text>
        </section>

        <!-- 8. 저장방법, 사용기간 -->
        <section>
          <title value="저장방법, 사용기간"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="44425-7"/><display value="Storage and handling section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml"><p><strong>저장방법:</strong> ${storage}</p><p><strong>사용기간:</strong> ${shelfLife}</p></div></text>
        </section>

        <!-- 9. 제조원 -->
        <section>
          <title value="제조원"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="42229-5"/><display value="SPL unclassified section"/></coding></code>
          <entry><reference value="urn:uuid:${manufOrgId}"/></entry>
        </section>

        <!-- 10. 수입자 -->
        <section>
          <title value="수입자"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="42229-5"/><display value="SPL unclassified section"/></coding></code>
          <entry><reference value="urn:uuid:${importerOrgId}"/></entry>
        </section>

        <!-- 11. 기타 -->
        <section>
          <title value="기타 안내사항"/>
          <code><coding><system value="2.16.840.1.113883.6.1"/><code value="42229-5"/><display value="SPL unclassified section"/></coding></code>
          <text><div xmlns="http://www.w3.org/1999/xhtml">${otherInfo}</div></text>
        </section>
      </Composition>
    </resource>
  </entry>

  <entry>
    <fullUrl value="urn:uuid:${authorOrgId}"/>
    <resource>
      <Organization>
        <id value="${authorOrgId}"/>
        <meta><profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Organization-uv-epi"/></meta>
        <name value="${escapeHtml(orgName)}"/>
      </Organization>
    </resource>
  </entry>

  <entry>
    <fullUrl value="urn:uuid:${manufOrgId}"/>
    <resource>
      <Organization>
        <id value="${manufOrgId}"/>
        <meta><profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Organization-uv-epi"/></meta>
        <name value="${escapeHtml(manufName)}"/>
      </Organization>
    </resource>
  </entry>

  <entry>
    <fullUrl value="urn:uuid:${importerOrgId}"/>
    <resource>
      <Organization>
        <id value="${importerOrgId}"/>
        <meta><profile value="http://hl7.org/fhir/uv/emedicinal-product-info/StructureDefinition/Organization-uv-epi"/></meta>
        <name value="${escapeHtml(importerName)}"/>
      </Organization>
    </resource>
  </entry>

</Bundle>`;

        downloadFile("epi-document.xml", xmlContent);
    }

    function downloadFile(filename, content) {
        const element = document.createElement('a');
        const blob = new Blob([content], {type: 'text/xml'});
        element.href = URL.createObjectURL(blob);
        element.download = filename;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
</script>

</body>
</html>
